<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUTA - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
        }
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0a0a1a;
            color: #e0e0e0;
        }
        
        /* Modern animations */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(-50%) scale(1);
            }
            40%, 43% {
                transform: translateY(-50%) scale(1.1);
            }
            70% {
                transform: translateY(-50%) scale(1.05);
            }
            90% {
                transform: translateY(-50%) scale(1.02);
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(99, 102, 241, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.6), 0 0 30px rgba(99, 102, 241, 0.4);
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-in-up {
            animation: slideInUp 0.5s ease-out;
        }
        
        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }
        .sidebar {
            width: var(--sidebar-width);
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                height: 100%;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            main {
                padding-left: 0;
            }
        }
        main {
            transition: padding-left 0.3s ease-in-out;
            padding-left: var(--sidebar-width);
        }
        .kpi-card, .content-card {
            background: rgba(26, 26, 78, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        .dropdown-panel {
            background-color: #1e1b34;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .sidebar-link {
            transition: all 0.2s ease;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(99, 102, 241, 0.2);
            color: #fff;
            border-right: 3px solid #6366f1;
        }
        .sidebar-link.active i, .sidebar-link:hover i {
            color: #818cf8;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal:not(.open) {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .modal.open {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .code-editor {
            font-family: 'Source Code Pro', monospace;
            background-color: #1a1a2e;
            border: 1px solid #2a2a4a;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111122; }
        ::-webkit-scrollbar-thumb { background: #2a2a4a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6366f1; }
    </style>
</head>
<body class="antialiased">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden"></div>
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar bg-[#111122] flex flex-col fixed top-0 left-0 h-full overflow-y-auto z-50">
            <div class="p-6 flex items-center gap-2">
                <h1 class="text-3xl font-black tracking-tighter text-white">OUTA</h1>
                <span class="bg-yellow-400 text-black text-xs font-bold px-2 py-1 rounded-full -translate-y-2">Admin</span>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <a href="#" class="sidebar-link active flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-dashboard">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-hosted-pages">
                    <i data-lucide="globe-2" class="w-5 h-5"></i> Hosted Pages
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-analytics">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i> Analytics
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-orders">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> Orders
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-products">
                    <i data-lucide="package" class="w-5 h-5"></i> Products
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-customers">
                    <i data-lucide="users" class="w-5 h-5"></i> Customers
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-conversions">
                    <i data-lucide="target" class="w-5 h-5"></i> Conversions
                </a>
                <a href="#" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300" data-page="page-notifications">
                    <i data-lucide="bell" class="w-5 h-5"></i> Notifications
                    <span id="sidebar-notification-count" class="ml-auto bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
            </nav>
            <div class="p-4 mt-auto border-t border-gray-700">
                 <a href="/home" class="sidebar-link flex items-center gap-3 p-3 rounded-md text-gray-300">
                    <i data-lucide="arrow-left-circle" class="w-5 h-5"></i> Back to Home
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 w-full">
             <!-- Header -->
            <header class="bg-[#111122]/80 backdrop-blur-sm sticky top-0 z-30 flex items-center justify-between p-4 border-b border-gray-800">
                <div class="flex items-center gap-4">
                    <button id="menu-btn" class="lg:hidden p-2 rounded-md hover:bg-gray-700">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-bold">Dashboard</h2>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                     <div class="hidden sm:block text-right">
                        <p id="current-time" class="text-sm font-semibold"></p>
                        <p id="current-date" class="text-xs text-gray-400"></p>
                    </div>
                    <!-- Notification Dropdown -->
                    <div class="relative">
                        <button id="notification-btn" class="p-2 rounded-full hover:bg-gray-700 relative">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span id="notification-dot" class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-[#111122]"></span>
                        </button>
                        <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 dropdown-panel rounded-md shadow-lg z-50 hidden">
                            <div class="p-3 font-bold border-b border-gray-700">Recent Notifications</div>
                            <div id="notification-dropdown-content" class="py-2 max-h-80 overflow-y-auto">
                                <div class="text-center py-4">
                                    <p class="text-xs text-gray-500">Loading notifications...</p>
                                </div>
                            </div>
                            <div class="p-2 text-center border-t border-gray-700">
                                <a href="#" id="view-all-notifications-btn" class="text-xs text-indigo-400 hover:underline">View All Notifications</a>
                            </div>
                        </div>
                    </div>
                    <!-- User Dropdown -->
                    <div class="relative">
                        <button id="user-menu-btn" class="block">
                            <div id="user-avatar" class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm">
                                <span id="user-avatar-text">U</span>
                            </div>
                        </button>
                        <div id="user-menu-dropdown" class="absolute right-0 mt-2 w-48 dropdown-panel rounded-md shadow-lg py-1 z-50 hidden">
                            <a href="#" id="admin-dashboard-link" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:bg-indigo-600/50 transition-colors hidden">
                                <i data-lucide="shield" class="w-4 h-4"></i> Admin Dashboard
                            </a>
                            <a href="#" id="profile-image-link" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:bg-indigo-600/50 transition-colors">
                                <i data-lucide="image" class="w-4 h-4"></i> Change Profile Image
                            </a>
                            <a href="#" id="sign-out-link" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:bg-indigo-600/50 transition-colors">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Profile Image Modal -->
            <div id="profile-image-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-gray-800 rounded-lg p-6 w-96 max-w-md mx-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white">Change Profile Image</h3>
                        <button id="close-profile-modal" class="text-gray-400 hover:text-white">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Image URL</label>
                        <input type="url" id="profile-image-url" placeholder="https://example.com/image.jpg" 
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Enter a direct link to your profile image</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="save-profile-image" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors">
                            Save Image
                        </button>
                        <button id="remove-profile-image" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors">
                            Remove
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 sm:p-6 md:p-8">
                <div id="page-dashboard" class="page-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="kpi-card p-5 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Total Visitors</p>
                            <p id="dashboard-total-visitors" class="text-2xl sm:text-3xl font-bold mt-2">0</p>
                            <p class="text-xs text-emerald-400 mt-1">Real-time data</p>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Total Revenue</p>
                            <p id="dashboard-total-revenue" class="text-2xl sm:text-3xl font-bold mt-2">$0</p>
                            <p class="text-xs text-emerald-400 mt-1">From all orders</p>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">Conversion Rate</p>
                            <p id="dashboard-conversion-rate" class="text-2xl sm:text-3xl font-bold mt-2">0%</p>
                            <p class="text-xs text-emerald-400 mt-1">Orders/Visitors</p>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <p class="text-sm font-medium text-gray-400">New Orders</p>
                            <p id="dashboard-new-orders" class="text-2xl sm:text-3xl font-bold mt-2">0</p>
                            <p class="text-xs text-emerald-400 mt-1">Total orders</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div class="lg:col-span-2 content-card p-5 rounded-lg">
                            <h3 class="font-bold mb-4">Sales Analytics</h3>
                            <div class="relative h-72"><canvas id="sales-chart"></canvas></div>
                        </div>
                    </div>
                    <div id="recent-orders-container" class="content-card rounded-lg"></div>
                </div>

                <div id="page-hosted-pages" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                            <h3 class="font-bold text-2xl">Your Hosted Pages</h3>
                            <div id="page-usage-indicator" class="mt-2"></div>
                        </div>
                        <button id="host-new-page-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 w-full sm:w-auto">
                            <i data-lucide="plus" class="w-5 h-5"></i> Host New Page
                        </button>
                    </div>
                    <div class="content-card rounded-lg">
                        <div id="pages-list-container" class="overflow-x-auto"></div>
                    </div>
                </div>

                <div id="page-analytics" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <div>
                             <h3 class="font-bold text-2xl flex items-center gap-2">
                                 <i data-lucide="bar-chart-3" class="w-6 h-6 text-blue-400"></i>
                                 Page Analytics
                             </h3>
                             <p id="analytics-page-title" class="text-sm text-gray-400">Showing data for all pages</p>
                        </div>
                        <select id="analytics-page-selector" class="bg-[#111122] border border-gray-700 rounded-md p-2 w-full sm:w-auto">
                            <option value="all">All Pages</option>
                        </select>
                    </div>
                    
                    <!-- Analytics KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="eye" class="w-6 h-6 text-white"></i>
                        </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Total Visitors</p>
                                    <p id="total-visitors" class="text-2xl sm:text-3xl font-bold mt-1">0</p>
                        </div>
                    </div>
                </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="users" class="w-6 h-6 text-white"></i>
                                </div>
                            <div>
                                    <p class="text-sm font-medium text-gray-400">Live Visitors</p>
                                    <p id="live-visitors" class="text-2xl sm:text-3xl font-bold mt-1 text-green-400">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="shopping-cart" class="w-6 h-6 text-white"></i>
                            </div>
                             <div>
                                    <p class="text-sm font-medium text-gray-400">Total Orders</p>
                                    <p id="total-orders" class="text-2xl sm:text-3xl font-bold mt-1">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="dollar-sign" class="w-6 h-6 text-white"></i>
                                </div>
                                        <div>
                                    <p class="text-sm font-medium text-gray-400">Total Revenue</p>
                                    <p id="total-revenue" class="text-2xl sm:text-3xl font-bold mt-1 text-green-400">$0</p>
                                        </div>
                                    </div>
                        </div>
                    </div>
                    
                    <!-- Additional Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                                        <div>
                                    <p class="text-sm font-medium text-gray-400">Conversion Rate</p>
                                    <p id="conversion-rate" class="text-2xl sm:text-3xl font-bold mt-1">0%</p>
                                        </div>
                                    </div>
                                </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-white"></i>
                            </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Avg. Time Spent</p>
                                    <p id="avg-time-spent" class="text-2xl sm:text-3xl font-bold mt-1">0s</p>
                        </div>
                            </div>
                        </div>
                        <div class="kpi-card p-5 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center">
                                    <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-400">Page Views</p>
                                    <p id="total-page-views" class="text-2xl sm:text-3xl font-bold mt-1">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="content-card p-5 rounded-lg">
                            <h3 class="font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-5 h-5 text-blue-400"></i>
                                Visitors by Day (Last 7 Days)
                            </h3>
                            <div class="relative h-72"><canvas id="visitors-by-day-chart"></canvas></div>
                        </div>
                        <div class="content-card p-5 rounded-lg">
                            <h3 class="font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-5 h-5 text-green-400"></i>
                                Visitors by City
                            </h3>
                            <div class="relative h-72"><canvas id="visitors-by-city-chart"></canvas></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                        <div class="content-card p-5 rounded-lg">
                            <h3 class="font-bold mb-4 flex items-center gap-2">
                                <i data-lucide="smartphone" class="w-5 h-5 text-purple-400"></i>
                                Visitors by Device
                            </h3>
                            <div class="relative h-72"><canvas id="visitors-by-device-chart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="page-orders" class="page-content hidden"><div id="all-orders-container" class="content-card rounded-lg p-5"></div></div>
                <div id="page-products" class="page-content hidden"><h3 class="font-bold text-2xl mb-6">Your Products</h3><div id="products-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div></div>
                <div id="page-customers" class="page-content hidden"><div id="all-customers-container" class="content-card rounded-lg p-5"></div></div>
                <div id="page-conversions" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <div>
                            <h3 class="font-bold text-2xl">Conversion Tracking</h3>
                            <p class="text-sm text-gray-400">Track button clicks and conversions from your hosted pages</p>
                                </div>
                            </div>
                    <div class="content-card rounded-lg">
                        <div id="conversions-list-container" class="overflow-x-auto"></div>
                                        </div>
                                    </div>

                <div id="page-notifications" class="page-content hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                        <div>
                            <h3 class="font-bold text-2xl">Notifications</h3>
                            <p class="text-sm text-gray-400">Stay updated with new orders and page expiration alerts</p>
                                        </div>
                        <div class="flex gap-2">
                            <button id="mark-all-read-btn" class="bg-gradient-to-r from-blue-500/20 to-blue-600/20 text-blue-300 border border-blue-500/40 rounded-lg px-4 py-2 text-sm font-medium hover:from-blue-500/30 hover:to-blue-600/30 hover:border-blue-500/60 transition-all duration-300 flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Mark All Read
                            </button>
                            <button id="check-expiring-btn" class="bg-gradient-to-r from-orange-500/20 to-orange-600/20 text-orange-300 border border-orange-500/40 rounded-lg px-4 py-2 text-sm font-medium hover:from-orange-500/30 hover:to-orange-600/30 hover:border-orange-500/60 transition-all duration-300 flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                Check Expiring
                            </button>
                                    </div>
                                </div>
                    <div class="content-card rounded-lg">
                        <div id="notifications-list-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="hosting-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4"><div class="modal-backdrop fixed inset-0"></div><div class="content-card rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col relative"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold">Host a New Page</h3><button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-700 -mr-2"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="p-6 overflow-y-auto flex-1"><div class="grid grid-cols-1 gap-6"><div><label for="page-title-input" class="block text-sm font-medium mb-2 text-gray-400">Page Title</label><input type="text" id="page-title-input" class="w-full bg-[#111122] border border-gray-700 rounded-md p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="e.g., Summer Sale Landing Page"></div><div><label for="full-code" class="block text-sm font-medium mb-2 text-gray-400">HTML, CSS & JS Code</label><textarea id="full-code" class="code-editor w-full p-4 rounded-md h-64" placeholder="<!-- Your entire page code goes here -->"></textarea></div><div><h2 class="text-md font-bold mb-3 text-gray-300">Dashboard Tracking (Optional)</h2><p class="text-xs text-gray-500 mb-4">Provide CSS selectors for elements on your page you want to track.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="track-conversion-btn" class="block text-xs font-medium mb-1 text-gray-400">Conversion Button Name</label><input type="text" id="track-conversion-btn" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder="Order Now, Buy Now, Get Started"></div><div><label for="track-product-name" class="block text-xs font-medium mb-1 text-gray-400">Product Name</label><input type="text" id="track-product-name" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder=".product-title, #p-name"></div><div><label for="track-product-price" class="block text-xs font-medium mb-1 text-gray-400">Product Price</label><input type="text" id="track-product-price" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder="#price, .amount"></div><div><label for="track-customer-name" class="block text-xs font-medium mb-1 text-gray-400">Customer Name Input</label><input type="text" id="track-customer-name" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder="input[name='customer_name']"></div><div><label for="track-customer-phone" class="block text-xs font-medium mb-1 text-gray-400">Customer Phone Input</label><input type="text" id="track-customer-phone" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder="#phone, input[name='phone']"></div><div><label for="track-customer-city" class="block text-xs font-medium mb-1 text-gray-400">Customer City Input</label><input type="text" id="track-customer-city" class="w-full bg-[#1a1a2e] border border-gray-600 rounded-md p-2 text-sm" placeholder="#city, input[name='city']"></div></div></div><div><h2 class="text-md font-bold mb-3 text-gray-300">Choose Hosting Duration</h2><div id="hosting-options-container" class="grid grid-cols-3 gap-4"></div></div></div></div><div class="p-6 border-t border-gray-700 flex justify-between items-center"><div id="modal-error" class="text-red-400 text-sm"></div><div class="flex gap-4"><button id="cancel-deploy-btn" class="py-2 px-5 rounded-lg font-semibold hover:bg-gray-700">Cancel</button><button id="deploy-btn" class="py-2 px-5 rounded-lg font-semibold bg-emerald-600 hover:bg-emerald-500 text-white flex items-center gap-2 disabled:opacity-50"><i data-lucide="rocket" class="w-5 h-5"></i> Deploy Now</button></div></div></div></div>
    <div id="delete-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4"><div class="modal-backdrop fixed inset-0"></div><div class="content-card rounded-xl w-full max-w-md relative"><div class="p-6 text-center"><i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-500"></i><h3 class="mt-4 text-xl font-bold">Delete Page?</h3><p class="mt-2 text-sm text-gray-400">Are you sure you want to delete this page? This action is permanent and cannot be undone.</p></div><div class="p-4 bg-gray-700/20 flex justify-end gap-4 rounded-b-xl"><button id="cancel-delete-btn" class="py-2 px-5 rounded-lg font-semibold hover:bg-gray-600">Cancel</button><button id="confirm-delete-btn" class="py-2 px-5 rounded-lg font-semibold bg-red-600 hover:bg-red-500 text-white">Delete</button></div></div></div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            pageLimit: 10,
            pages: [],
            orders: [],
            customers: [],
            conversions: [],
            analytics: {},
            notifications: []
        };
        let pageIdToDelete = null;

        // --- CHARTING ---
        const chartInstances = { sales: null, traffic: null, country: null, device: null };
        const commonChartOptions = {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#e0e0e0' } } },
            scales: {
                x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
            }
        };

        const renderChart = (ctxId, config) => {
            const ctx = document.getElementById(ctxId)?.getContext('2d');
            if (!ctx) return;
            if (chartInstances[ctxId]) chartInstances[ctxId].destroy();
            chartInstances[ctxId] = new Chart(ctx, config);
        };
        
        // --- NOTIFICATION FUNCTIONS ---
        const fetchNotifications = async () => {
            try {
                const response = await fetch('/api/notifications');
                const data = await response.json();
                console.log('Notifications response:', data);
                
                if (data.success) {
                    state.notifications = data.notifications;
                    renderNotifications();
                    updateNotificationCount();
                } else {
                    console.error('Failed to fetch notifications:', data.message);
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        };

        const renderNotifications = () => {
            // Render main notifications page
            if (state.notifications.length === 0) {
                getElement('notifications-list-container').innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="bell-off" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                        <p class="text-gray-400 text-lg">No notifications yet</p>
                        <p class="text-gray-500 text-sm mt-2">You'll receive notifications for new orders and page expiration alerts</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } else {
                const notificationRows = state.notifications.map(notification => {
                    const typeIcon = getNotificationIcon(notification.type);
                    const typeColor = getNotificationColor(notification.type);
                    const isReadClass = notification.is_read ? 'opacity-60' : '';
                    
                    return `
                        <div class="notification-item border-b border-gray-700/30 p-4 hover:bg-gradient-to-r hover:from-gray-800/30 hover:to-gray-700/30 transition-all duration-300 ${isReadClass}" data-notification-id="${notification.id}">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 ${typeColor} rounded-full flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="${typeIcon}" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <h4 class="font-semibold text-gray-200 text-sm">${notification.title}</h4>
                                        <span class="text-xs text-gray-500">${notification.time_ago}</span>
                                    </div>
                                    <p class="text-gray-400 text-sm mt-1">${notification.message}</p>
                                    ${!notification.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>' : ''}
                                </div>
                                ${!notification.is_read ? `
                                    <button onclick="markNotificationRead(${notification.id})" class="mark-read-btn p-1 text-gray-500 hover:text-blue-400 transition-colors duration-200">
                                        <i data-lucide="check" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                getElement('notifications-list-container').innerHTML = `
                    <div class="notifications-list">
                        ${notificationRows}
                    </div>
                `;
            }

            // Render dropdown notifications (show only recent 3)
            const recentNotifications = state.notifications.slice(0, 3);
            if (recentNotifications.length === 0) {
                getElement('notification-dropdown-content').innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-xs text-gray-500">No notifications yet</p>
                    </div>
                `;
            } else {
                const dropdownContent = recentNotifications.map(notification => {
                    const typeIcon = getNotificationIcon(notification.type);
                    const typeColor = getNotificationColor(notification.type);
                    
                    return `
                        <a href="#" class="flex items-start gap-3 px-4 py-3 text-sm text-gray-300 hover:bg-indigo-600/20 transition-colors" onclick="markNotificationRead(${notification.id})">
                            <div class="${typeColor} p-2 rounded-full">
                                <i data-lucide="${typeIcon}" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                                <p><strong>${notification.title}</strong></p>
                                <p class="text-xs text-gray-500 mt-1">${notification.time_ago}</p>
                            </div>
                        </a>
                    `;
                }).join('');

                getElement('notification-dropdown-content').innerHTML = dropdownContent;
            }

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const getNotificationIcon = (type) => {
            switch (type) {
                case 'new_order': return 'shopping-cart';
                case 'page_expiring': return 'clock';
                case 'page_expired': return 'alert-triangle';
                default: return 'bell';
            }
        };

        const getNotificationColor = (type) => {
            switch (type) {
                case 'new_order': return 'bg-gradient-to-br from-green-500 to-green-600';
                case 'page_expiring': return 'bg-gradient-to-br from-orange-500 to-orange-600';
                case 'page_expired': return 'bg-gradient-to-br from-red-500 to-red-600';
                default: return 'bg-gradient-to-br from-blue-500 to-blue-600';
            }
        };

        const updateNotificationCount = () => {
            const unreadCount = state.notifications.filter(n => !n.is_read).length;
            const countElement = getElement('sidebar-notification-count');
            const notificationDot = getElement('notification-dot');
            
            if (unreadCount > 0) {
                countElement.textContent = unreadCount;
                countElement.classList.remove('hidden');
                notificationDot.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
                notificationDot.classList.add('hidden');
            }
        };

        const markNotificationRead = async (notificationId) => {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update local state
                    const notification = state.notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.is_read = true;
                    }
                    
                    // Re-render notifications
                    renderNotifications();
                    updateNotificationCount();
                } else {
                    console.error('Failed to mark notification as read:', data.message);
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        };

        const markAllNotificationsRead = async () => {
            try {
                const response = await fetch('/api/notifications/read-all', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Update local state
                    state.notifications.forEach(n => n.is_read = true);
                    
                    // Re-render notifications
                    renderNotifications();
                    updateNotificationCount();
                } else {
                    console.error('Failed to mark all notifications as read:', data.message);
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        };

        const checkExpiringPages = async () => {
            try {
                const response = await fetch('/api/notifications/check-expiring');
                const data = await response.json();
                
                if (data.success) {
                    // Refresh notifications
                    await fetchNotifications();
                } else {
                    console.error('Failed to check expiring pages:', data.message);
                }
            } catch (error) {
                console.error('Error checking expiring pages:', error);
            }
        };

        // --- API FUNCTIONS ---
        const fetchPages = async () => {
            try {
                const response = await fetch('/api/host/pages');
                const data = await response.json();
                if (data.success) {
                    state.pages = data.pages;
                    state.pageLimit = data.pageLimit;
                    renderHostedPages();
                    renderPageUsage();
                    renderProducts();
                }
            } catch (error) {
                console.error('Error fetching pages:', error);
            }
        };

        const fetchOrders = async () => {
            try {
                console.log('Fetching orders...');
                const response = await fetch('/api/host/orders');
                const data = await response.json();
                console.log('Orders response:', data);
                if (data.success) {
                    state.orders = data.orders;
                    console.log('Orders loaded:', state.orders);
                    renderOrders();
                } else {
                    console.error('Failed to fetch orders:', data.message);
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        };

        const fetchCustomers = async () => {
            try {
                const response = await fetch('/api/host/customers');
                const data = await response.json();
                if (data.success) {
                    state.customers = data.customers;
                    renderCustomers();
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
            }
        };

        const fetchConversions = async () => {
            try {
                const response = await fetch('/api/host/conversions');
                const data = await response.json();
                if (data.success) {
                    state.conversions = data.conversions;
                    renderConversions();
                }
            } catch (error) {
                console.error('Error fetching conversions:', error);
            }
        };

        const fetchAnalytics = async (projectId = null) => {
            try {
                const url = projectId ? `/api/host/analytics?project_id=${projectId}` : '/api/host/analytics';
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    state.analytics = data.analytics;
                    updateAnalyticsDisplay();
                    updateAnalyticsCharts();
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        };

        const updateAnalyticsDisplay = () => {
            const analytics = state.analytics;
            if (!analytics) return;
            
            // Update KPI cards
            getElement('total-visitors').textContent = analytics.totalViews || 0;
            getElement('live-visitors').textContent = analytics.liveVisitors || 0;
            getElement('total-orders').textContent = analytics.totalOrders || 0;
            getElement('total-revenue').textContent = `$${analytics.totalMoney || 0}`;
            getElement('conversion-rate').textContent = `${analytics.conversionRate || 0}%`;
            getElement('avg-time-spent').textContent = `${analytics.avgTimeSpent || 0}s`;
            getElement('total-page-views').textContent = analytics.totalViews || 0;
            
            // Update dashboard KPI cards
            getElement('dashboard-total-visitors').textContent = analytics.totalViews || 0;
            getElement('dashboard-total-revenue').textContent = `$${analytics.totalMoney || 0}`;
            getElement('dashboard-conversion-rate').textContent = `${analytics.conversionRate || 0}%`;
            getElement('dashboard-new-orders').textContent = analytics.totalOrders || 0;
            
            // Update sales chart with real data
            if (analytics.visitorsByDay) {
                renderChart('sales-chart', { 
                    type: 'line', 
                    data: { 
                        labels: analytics.visitorsByDay.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], 
                        datasets: [{ 
                            label: 'Visitors', 
                            data: analytics.visitorsByDay.data || [0, 0, 0, 0, 0, 0, 0], 
                            borderColor: '#6366f1', 
                            backgroundColor: 'rgba(99, 102, 241, 0.2)', 
                            fill: true, 
                            tension: 0.4 
                        }] 
                    }, 
                    options: commonChartOptions 
                });
            }
        };
        
        const generateAnalyticsData = () => ({
            visitorsByDay: state.analytics.visitorsByDay || { labels: [], data: [] },
            visitorsByCity: state.analytics.visitorsByCity || { labels: [], data: [] },
            visitorsByDevice: state.analytics.visitorsByDevice || { labels: ['Desktop', 'Mobile', 'Tablet'], data: [0, 0, 0] }
        });

        const updateAnalyticsCharts = (pageId) => {
            const page = state.pages.find(p => p.id === pageId);
            const title = page ? page.title : "All Pages";
            getElement("analytics-page-title").textContent = `Showing data for: ${title}`;
            
            const analyticsData = generateAnalyticsData();
            
            // Visitors by Day Chart
            renderChart('visitors-by-day-chart', {
                type: 'line',
                data: {
                    labels: analyticsData.visitorsByDay.labels,
                    datasets: [{
                        label: 'Visitors',
                        data: analyticsData.visitorsByDay.data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: commonChartOptions
            });
            
            // Visitors by City Chart
            renderChart('visitors-by-city-chart', {
                type: 'bar',
                data: {
                    labels: analyticsData.visitorsByCity.labels,
                    datasets: [{
                        label: 'Visitors',
                        data: analyticsData.visitorsByCity.data,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: '#22c55e',
                        borderWidth: 1
                    }]
                },
                options: commonChartOptions
            });
            
            // Visitors by Device Chart
            renderChart('visitors-by-device-chart', {
                type: 'doughnut',
                data: {
                    labels: analyticsData.visitorsByDevice.labels,
                    datasets: [{
                        data: analyticsData.visitorsByDevice.data,
                        backgroundColor: ['#818cf8', '#60a5fa', '#34d399']
                    }]
                },
                options: { ...commonChartOptions, scales: {} }
            });
            
        };


        // --- UI ELEMENTS & HELPERS ---
        const getElement = (id) => document.getElementById(id);
        const query = (selector) => document.querySelector(selector);
        const queryAll = (selector) => document.querySelectorAll(selector);

        // --- NAVIGATION LOGIC ---
        const sidebar = getElement('sidebar');
        const sidebarOverlay = getElement('sidebar-overlay');

        const closeSidebar = () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        };

        const navigateToPage = (pageId, contextId = null) => {
            queryAll('.sidebar-link').forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
            queryAll('.page-content').forEach(page => page.classList.toggle('hidden', page.id !== pageId));
            const activeLink = query(`.sidebar-link[data-page="${pageId}"]`);
            getElement('page-title').textContent = activeLink.textContent.trim();
            if (window.innerWidth < 1024) closeSidebar();

            setTimeout(() => {
                if (pageId === 'page-dashboard') {
                    fetchAnalytics();
                    fetchOrders();
                    // Render sales chart with real data after analytics are loaded
                    setTimeout(() => {
                        if (state.analytics && state.analytics.visitorsByDay) {
                            renderChart('sales-chart', { 
                                type: 'line', 
                                data: { 
                                    labels: state.analytics.visitorsByDay.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], 
                                    datasets: [{ 
                                        label: 'Visitors', 
                                        data: state.analytics.visitorsByDay.data || [0, 0, 0, 0, 0, 0, 0], 
                                        borderColor: '#6366f1', 
                                        backgroundColor: 'rgba(99, 102, 241, 0.2)', 
                                        fill: true, 
                                        tension: 0.4 
                                    }] 
                                }, 
                                options: commonChartOptions 
                            });
                        } else {
                            // Fallback to sample data if no real data available
                            renderChart('sales-chart', { type: 'line', data: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], datasets: [{ label: 'Visitors', data: [0, 0, 0, 0, 0, 0, 0], borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.2)', fill: true, tension: 0.4 }] }, options: commonChartOptions });
                        }
                    }, 500);
                }
                if (pageId === 'page-analytics') {
                    // Ensure pages are loaded before populating selector
                    const loadAnalytics = async () => {
                        if (state.pages.length === 0) {
                            await fetchPages();
                        }
                        populateAnalyticsSelector();
                        fetchAnalytics(contextId);
                    getElement('analytics-page-selector').value = contextId || 'all';
                    updateAnalyticsCharts(contextId);
                    };
                    loadAnalytics();
                }
                if (pageId === 'page-hosted-pages') {
                    fetchPages();
                    renderPageUsage();
                }
                if (pageId === 'page-orders') {
                    fetchOrders();
                }
                if (pageId === 'page-customers') {
                    fetchCustomers();
                }
                if (pageId === 'page-conversions') {
                    fetchConversions();
                }
                if (pageId === 'page-notifications') {
                    fetchNotifications();
                }
            }, 0);
        };
        
        queryAll('.sidebar-link').forEach(link => {
            if (link.dataset.page) {
                 link.addEventListener('click', (e) => { e.preventDefault(); navigateToPage(link.dataset.page); });
            }
        });
        
        const userMenuDropdown = getElement('user-menu-dropdown');
        const notificationDropdown = getElement('notification-dropdown');

        getElement('menu-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.contains('open') ? closeSidebar() : sidebar.classList.add('open'); sidebarOverlay.classList.remove('hidden');
        });
        sidebarOverlay.addEventListener('click', closeSidebar);
        
        getElement('user-menu-btn').addEventListener('click', (e) => { 
            e.stopPropagation();
            userMenuDropdown.classList.toggle('hidden');
            notificationDropdown.classList.add('hidden');
        });

        // Notification button click handler
        getElement('notification-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            notificationDropdown.classList.toggle('hidden');
            userMenuDropdown.classList.add('hidden');
        });
        
        // Account dropdown functionality
        getElement('sign-out-link').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '/logout';
            }
        });

        getElement('admin-dashboard-link').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/superadmin';
        });

        // Profile image modal functionality
        getElement('profile-image-link').addEventListener('click', (e) => {
            e.preventDefault();
            getElement('profile-image-modal').classList.remove('hidden');
            userMenuDropdown.classList.add('hidden');
        });

        getElement('close-profile-modal').addEventListener('click', () => {
            getElement('profile-image-modal').classList.add('hidden');
        });

        getElement('save-profile-image').addEventListener('click', async () => {
            const imageUrl = getElement('profile-image-url').value.trim();
            
            if (!imageUrl) {
                alert('Please enter an image URL');
                return;
            }

            try {
                const response = await fetch('/api/user/profile-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image_url: imageUrl })
                });

                const data = await response.json();

                if (data.success) {
                    // Update avatar immediately
                    const user = await fetch('/api/user/profile').then(r => r.json());
                    if (user.success) {
                        updateUserAvatar(user.user);
                    }
                    
                    getElement('profile-image-modal').classList.add('hidden');
                    getElement('profile-image-url').value = '';
                    alert('Profile image updated successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating profile image:', error);
                alert('Failed to update profile image. Please try again.');
            }
        });

        getElement('remove-profile-image').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to remove your profile image?')) {
                return;
            }

            try {
                const response = await fetch('/api/user/profile-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image_url: '' })
                });

                const data = await response.json();

                if (data.success) {
                    // Update avatar immediately
                    const user = await fetch('/api/user/profile').then(r => r.json());
                    if (user.success) {
                        updateUserAvatar(user.user);
                    }
                    
                    getElement('profile-image-modal').classList.add('hidden');
                    getElement('profile-image-url').value = '';
                    alert('Profile image removed successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error removing profile image:', error);
                alert('Failed to remove profile image. Please try again.');
            }
        });
        
        getElement('view-all-notifications-btn').addEventListener('click', (e) => {
             e.preventDefault();
             navigateToPage('page-orders');
             notificationDropdown.classList.add('hidden');
        });

        // Notification button event listeners
        getElement('mark-all-read-btn').addEventListener('click', markAllNotificationsRead);
        getElement('check-expiring-btn').addEventListener('click', checkExpiringPages);


        window.addEventListener('click', (e) => {
            userMenuDropdown.classList.add('hidden');
            notificationDropdown.classList.add('hidden');
            
            // Close profile modal if clicking outside
            const modal = getElement('profile-image-modal');
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });


        // --- RENDER FUNCTIONS ---
        const getStatusBadge = (status) => {
            const statusClasses = { 
                'Processing': 'bg-gradient-to-r from-yellow-500/20 to-yellow-600/20 text-yellow-300 border border-yellow-500/40 shadow-lg shadow-yellow-500/10', 
                'Shipping': 'bg-gradient-to-r from-blue-500/20 to-blue-600/20 text-blue-300 border border-blue-500/40 shadow-lg shadow-blue-500/10', 
                'Completed': 'bg-gradient-to-r from-emerald-500/20 to-emerald-600/20 text-emerald-300 border border-emerald-500/40 shadow-lg shadow-emerald-500/10', 
                'Cancelled': 'bg-gradient-to-r from-red-500/20 to-red-600/20 text-red-300 border border-red-500/40 shadow-lg shadow-red-500/10',
                'Shipped': 'bg-gradient-to-r from-emerald-500/20 to-emerald-600/20 text-emerald-300 border border-emerald-500/40 shadow-lg shadow-emerald-500/10', 
                'Delivered': 'bg-gradient-to-r from-blue-500/20 to-blue-600/20 text-blue-300 border border-blue-500/40 shadow-lg shadow-blue-500/10', 
                'Live': 'bg-gradient-to-r from-emerald-500/20 to-emerald-600/20 text-emerald-300 border border-emerald-500/40 shadow-lg shadow-emerald-500/10' 
            };
            return `<span class="${statusClasses[status] || 'bg-gradient-to-r from-gray-500/20 to-gray-600/20 text-gray-300 border border-gray-500/40 shadow-lg shadow-gray-500/10'} text-xs font-semibold px-4 py-2 rounded-full inline-flex items-center gap-2 backdrop-blur-sm transition-all duration-300 hover:scale-105">
                <span class="w-2 h-2 rounded-full ${getStatusDotColor(status)} animate-pulse"></span>
                ${status}
            </span>`;
        };
        
        const getStatusDotColor = (status) => {
            const dotColors = {
                'Processing': 'bg-yellow-400',
                'Shipping': 'bg-blue-400', 
                'Completed': 'bg-emerald-400',
                'Cancelled': 'bg-red-400',
                'Shipped': 'bg-emerald-400',
                'Delivered': 'bg-blue-400',
                'Live': 'bg-emerald-400'
            };
            return dotColors[status] || 'bg-gray-400';
        };
        const createTable = (headers, rows) => `<div class="overflow-hidden rounded-xl border border-gray-700/50 shadow-2xl backdrop-blur-sm bg-gradient-to-br from-gray-900/80 to-gray-800/80"><table class="w-full text-sm text-left"><thead class="bg-gradient-to-r from-gray-800/90 to-gray-700/90 border-b border-gray-600/50 text-xs text-gray-300 uppercase font-semibold tracking-wider"><tr>${headers}</tr></thead><tbody class="divide-y divide-gray-700/30">${rows}</tbody></table></div>`;
        
        const renderOrders = () => {
            renderRecentOrders();
            renderAllOrders();
        };
        
        const renderRecentOrders = () => { 
            const recentOrderRows = state.orders.slice(0, 5).map(order => {
                return `<tr class="border-b border-gray-800 hover:bg-gray-700/20">
                    <td class="px-6 py-4 font-mono text-indigo-400">${order.id}</td>
                    <td class="px-6 py-4">${order.customer}</td>
                    <td class="px-6 py-4">${getStatusBadge(order.status)}</td>
                    <td class="px-6 py-4 text-right font-medium">${order.amount}</td>
                </tr>`;
            }).join('');
            
            getElement('recent-orders-container').innerHTML = `
                <h3 class="font-bold p-5">Recent Orders</h3>
                <div class="overflow-x-auto">
                    ${createTable(
                        '<th scope="col" class="px-6 py-3">Order ID</th><th scope="col" class="px-6 py-3">Customer</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3 text-right">Amount</th>',
                        recentOrderRows
                    )}
                </div>
            `;
        };
        const renderAllOrders = () => { 
            const orderRows = state.orders.map(o => {
                const orderId = o.id.replace('ORD-', ''); // Extract numeric ID
                return `<tr class="border-b border-gray-700/30 hover:bg-gradient-to-r hover:from-gray-800/30 hover:to-gray-700/30 transition-all duration-300 group">
                    <td class="px-6 py-4 font-mono text-indigo-400 font-semibold tracking-wide">${o.id}</td>
                    <td class="px-6 py-4 text-gray-200 font-medium">${o.customer}</td>
                    <td class="px-6 py-4 text-gray-300">${o.phone || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-300">${o.city || 'N/A'}</td>
                    <td class="px-6 py-4 text-gray-200 font-medium">${o.product || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <select class="status-select bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-600/50 rounded-lg px-4 py-2.5 text-sm font-medium focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-400 transition-all duration-300 hover:border-gray-500/70 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-800 shadow-lg backdrop-blur-sm group-hover:shadow-xl group-hover:shadow-indigo-500/10" data-order-id="${orderId}" onchange="updateOrderStatus(${orderId}, this.value)">
                            <option value="Processing" ${o.status === 'Processing' ? 'selected' : ''} style="color: #fbbf24; background: linear-gradient(135deg, #1f2937, #374151); font-weight: 500;"> Processing</option>
                            <option value="Shipping" ${o.status === 'Shipping' ? 'selected' : ''} style="color: #60a5fa; background: linear-gradient(135deg, #1f2937, #374151); font-weight: 500;"> Shipping</option>
                            <option value="Completed" ${o.status === 'Completed' ? 'selected' : ''} style="color: #34d399; background: linear-gradient(135deg, #1f2937, #374151); font-weight: 500;"> Completed</option>
                            <option value="Cancelled" ${o.status === 'Cancelled' ? 'selected' : ''} style="color: #f87171; background: linear-gradient(135deg, #1f2937, #374151); font-weight: 500;"> Cancelled</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 text-gray-400 font-medium">${o.date}</td>
                    <td class="px-6 py-4 text-right font-semibold text-green-400">${o.amount}</td>
                    <td class="px-6 py-4 text-center">
                        ${o.status === 'Cancelled' ? 
                            `<button onclick="deleteOrder(${orderId})" class="delete-order-btn bg-gradient-to-r from-red-500/20 to-red-600/20 text-red-300 border border-red-500/40 rounded-lg px-3 py-2 text-sm font-medium hover:from-red-500/30 hover:to-red-600/30 hover:border-red-500/60 transition-all duration-300 flex items-center gap-2 shadow-lg shadow-red-500/10 hover:shadow-red-500/20">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Delete
                            </button>` : 
                            '<span class="text-gray-500 text-sm">-</span>'
                        }
                    </td>
                </tr>`;
            }).join('');
            
            getElement('all-orders-container').innerHTML = `
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="list-ordered" class="w-5 h-5 text-indigo-400"></i>
                    All Orders
                </h3>
                <div class="overflow-x-auto animate-slide-in-up">
                    ${createTable(
                        '<th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="hash" class="w-4 h-4 text-indigo-400"></i>Order ID</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-blue-400"></i>Customer</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-green-400"></i>Phone</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-orange-400"></i>City</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="package" class="w-4 h-4 text-purple-400"></i>Product</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-yellow-400"></i>Status</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>Date</span></th><th class="px-6 py-4 text-right"><span class="flex items-center gap-2 justify-end"><i data-lucide="dollar-sign" class="w-4 h-4 text-green-400"></i>Amount</span></th><th class="px-6 py-4 text-center"><span class="flex items-center gap-2 justify-center"><i data-lucide="settings" class="w-4 h-4 text-gray-400"></i>Actions</span></th>',
                        orderRows
                    )}
                </div>
            `;
            
            // Initialize Lucide icons for the new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const deleteOrder = async (orderId) => {
            try {
                // Show confirmation dialog
                if (!confirm('Are you sure you want to delete this cancelled order? This action cannot be undone.')) {
                    return;
                }

                console.log(`Deleting order ${orderId}`);
                const response = await fetch(`/api/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                console.log('Delete order response:', data);
                
                if (data.success) {
                    // Remove order from state
                    state.orders = state.orders.filter(o => o.id.replace('ORD-', '') != orderId);
                    
                    // Re-render orders
                    renderOrders();
                    
                    // Show success message
                    const deleteBtn = document.querySelector(`button[onclick="deleteOrder(${orderId})"]`);
                    if (deleteBtn) {
                        deleteBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>Deleted';
                        deleteBtn.classList.remove('from-red-500/20', 'to-red-600/20', 'text-red-300', 'border-red-500/40');
                        deleteBtn.classList.add('from-green-500/20', 'to-green-600/20', 'text-green-300', 'border-green-500/40');
                        deleteBtn.disabled = true;
                        
                        // Re-initialize icons
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                        
                        // Remove the button after 2 seconds
                        setTimeout(() => {
                            deleteBtn.parentElement.innerHTML = '<span class="text-gray-500 text-sm">Deleted</span>';
                        }, 2000);
                    }
                } else {
                    console.error('Failed to delete order:', data.message);
                    alert('Failed to delete order: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Failed to delete order. Please try again.');
            }
        };

        const renderCustomers = () => {
            if (state.customers.length === 0) {
                getElement('all-customers-container').innerHTML = `
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-blue-400"></i>
                        All Customers
                    </h3>
                    <div class="text-center py-12">
                        <i data-lucide="user-x" class="w-16 h-16 mx-auto text-gray-500 mb-4"></i>
                        <p class="text-gray-400 text-lg">No customers yet</p>
                        <p class="text-gray-500 text-sm mt-2">Customers will appear here when they place orders from your hosted pages</p>
                    </div>
                `;
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                return;
            }

            const customerRows = state.customers.map(c => {
                return `<tr class="border-b border-gray-700/30 hover:bg-gradient-to-r hover:from-gray-800/30 hover:to-gray-700/30 transition-all duration-300 group">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                                ${c.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold text-gray-200">${c.name}</div>
                                <div class="text-xs text-gray-500">${c.orderCount} order${c.orderCount !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="phone" class="w-4 h-4 text-green-400"></i>
                            <span class="font-mono text-gray-300">${c.phone}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-orange-400"></i>
                            <span class="text-gray-300">${c.city || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="font-bold text-green-400 text-lg">${c.totalSpent}</div>
                    </td>
                </tr>`;
            }).join('');

            getElement('all-customers-container').innerHTML = `
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5 text-blue-400"></i>
                    All Customers (${state.customers.length})
                </h3>
                <div class="overflow-x-auto animate-slide-in-up">
                    ${createTable(
                        '<th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="user" class="w-4 h-4 text-blue-400"></i>Customer</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-green-400"></i>Phone Number</span></th><th class="px-6 py-4 text-left"><span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-orange-400"></i>City</span></th><th class="px-6 py-4 text-right"><span class="flex items-center gap-2 justify-end"><i data-lucide="dollar-sign" class="w-4 h-4 text-green-400"></i>Total Spent</span></th>',
                        customerRows
                    )}
                </div>
            `;
            
            // Initialize Lucide icons for the new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        const updateOrderStatus = async (orderId, newStatus) => {
            try {
                console.log(`Updating order ${orderId} status to ${newStatus}`);
                
                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                console.log('Status update response:', data);
                
                if (data.success) {
                    // Update the order in state
                    const orderIndex = state.orders.findIndex(o => o.id.replace('ORD-', '') == orderId);
                    if (orderIndex !== -1) {
                        state.orders[orderIndex].status = newStatus;
                        renderOrders(); // Re-render to show updated status
                    }
                    
                    // Show success message with modern animation
                    const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
                    if (selectElement) {
                        selectElement.style.borderColor = '#22c55e';
                        selectElement.style.boxShadow = '0 0 0 3px rgba(34, 197, 94, 0.2), 0 0 20px rgba(34, 197, 94, 0.3)';
                        selectElement.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
                        selectElement.style.transform = 'scale(1.02)';
                        selectElement.style.transition = 'all 0.3s ease';
                        
                        // Add success icon temporarily
                        const successIcon = document.createElement('span');
                        successIcon.innerHTML = '';
                        successIcon.style.position = 'absolute';
                        successIcon.style.right = '-30px';
                        successIcon.style.top = '50%';
                        successIcon.style.transform = 'translateY(-50%)';
                        successIcon.style.fontSize = '16px';
                        successIcon.style.animation = 'bounce 0.6s ease';
                        
                        selectElement.style.position = 'relative';
                        selectElement.parentElement.style.position = 'relative';
                        selectElement.parentElement.appendChild(successIcon);
                        
                        setTimeout(() => {
                            selectElement.style.borderColor = '';
                            selectElement.style.boxShadow = '';
                            selectElement.style.backgroundColor = '';
                            selectElement.style.transform = '';
                            if (successIcon.parentElement) {
                                successIcon.parentElement.removeChild(successIcon);
                            }
                        }, 2000);
                    }
                } else {
                    console.error('Failed to update order status:', data.message);
                    alert('Failed to update order status: ' + data.message);
                    
                    // Revert the select value
                    const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
                    if (selectElement) {
                        selectElement.value = state.orders.find(o => o.id.replace('ORD-', '') == orderId)?.status || 'Processing';
                    }
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status. Please try again.');
                
                // Revert the select value
                const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
                if (selectElement) {
                    selectElement.value = state.orders.find(o => o.id.replace('ORD-', '') == orderId)?.status || 'Processing';
                }
            }
        };

        const renderConversions = () => {
            const container = getElement('conversions-list-container');
            if (!container) return;
            
            if (state.conversions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <i data-lucide="target" class="w-16 h-16 mx-auto text-gray-600"></i>
                        <h3 class="mt-4 text-lg font-semibold">No Conversions Yet</h3>
                        <p class="mt-1 text-sm text-gray-400">Conversions will appear here when visitors click your tracked buttons.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            const tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="border-b border-gray-700 text-xs text-gray-400 uppercase">
                        <tr>
                            <th class="px-6 py-3">Project</th>
                            <th class="px-6 py-3">Button</th>
                            <th class="px-6 py-3">IP Address</th>
                            <th class="px-6 py-3">Date & Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.conversions.map(conversion => `
                            <tr class="border-b border-gray-800 hover:bg-gray-700/20">
                                <td class="px-6 py-4 font-medium">${conversion.project_name}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-green-500/20 text-green-400">
                                        ${conversion.button_name}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-400">${conversion.ip_address || 'Unknown'}</td>
                                <td class="px-6 py-4 text-gray-400">${new Date(conversion.created_at).toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            lucide.createIcons();
        };
        
        const renderProducts = () => {
            const container = getElement('products-list-container');
            // Filter pages that have product data
            const productsFromPages = state.pages.filter(p => p.product_name && p.product_name.trim() !== '');
            
            if (productsFromPages.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i data-lucide="package" class="w-16 h-16 mx-auto text-gray-600"></i>
                        <h3 class="mt-4 text-lg font-semibold">No Products Found</h3>
                        <p class="mt-1 text-sm text-gray-400">Products appear here when you host a page with product name and price.</p>
                    </div>
                `;
            } else {
                container.innerHTML = productsFromPages.map(p => `
                    <div class="content-card rounded-lg overflow-hidden">
                        <img src="https://placehold.co/600x400/0a0a1a/e0e0e0?text=${encodeURIComponent(p.product_name)}" alt="Product Image" class="w-full h-40 object-cover">
                        <div class="p-4">
                            <h4 class="font-bold">${p.product_name}</h4>
                            <p class="text-sm text-gray-400 mb-2">${p.product_price || 'Price not set'}</p>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-emerald-400">In Stock: 100</span>
                                <a href="/page/${p.id}" target="_blank" class="text-indigo-400 hover:underline">View Page</a>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            lucide.createIcons();
        };

        const renderHostedPages = () => {
            const container = getElement('pages-list-container');
            if (!container) return;
            
            if (state.pages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <i data-lucide="globe-2" class="w-16 h-16 mx-auto text-gray-600"></i>
                        <h3 class="mt-4 text-lg font-semibold">No Hosted Pages</h3>
                        <p class="mt-1 text-sm text-gray-400">Create your first hosted page to get started.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            const tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="border-b border-gray-700 text-xs text-gray-400 uppercase">
                        <tr>
                            <th class="px-6 py-3">Page Title</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">URL</th>
                            <th class="px-6 py-3">Expires</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${state.pages.map(page => `
                            <tr class="border-b border-gray-800 hover:bg-gray-700/20" data-page-id="${page.id}">
                                <td class="px-6 py-4 font-medium">${page.title}</td>
                                <td class="px-6 py-4">
                                    <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-emerald-500/20 text-emerald-400">
                                        ${page.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <span class="text-indigo-400 font-mono text-xs">localhost:5000/page/${page.id}</span>
                                        <button onclick="copyToClipboard('http://localhost:5000/page/${page.id}')" class="p-1 hover:bg-gray-600 rounded" title="Copy URL">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-gray-400">${page.expirationDate}</td>
                                <td class="px-6 py-4 text-right">
                                    <div class="flex items-center justify-end gap-2">
                                        <a href="/page/${page.id}" target="_blank" class="p-2 hover:bg-indigo-500/20 rounded-md" title="View Live">
                                            <i data-lucide="external-link" class="w-4 h-4 text-indigo-400"></i>
                                        </a>
                                        <button class="p-2 hover:bg-red-500/20 rounded-md delete-page-btn" data-page-id="${page.id}" title="Delete">
                                            <i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            lucide.createIcons();
        };

        const renderPageUsage = () => {
            const container = getElement('page-usage-indicator');
            const used = state.pages.length;
            const limit = state.pageLimit;
            const percentage = limit > 0 ? (used / limit) * 100 : 0;
            container.innerHTML = `
                <p class="text-sm font-semibold text-white">${used} / ${limit} Pages Hosted</p>
                <div class="w-full bg-gray-700 rounded-full h-1.5 mt-1">
                    <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${percentage}%"></div>
                </div>
            `;
            getElement('deploy-btn').disabled = used >= limit;
        };

        // Copy to clipboard function
        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                // Show a brief success message
                const button = event.target.closest('button');
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i data-lucide="check" class="w-3 h-3 text-green-400"></i>';
                lucide.createIcons();
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    lucide.createIcons();
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        };

        // Delete hosted page function
        const deleteHostedPage = async (pageId) => {
            if (!confirm('Are you sure you want to delete this hosted page? This action cannot be undone.')) {
                return;
            }
            
            // Find the delete button and show loading state
            const deleteBtn = document.querySelector(`[data-page-id="${pageId}"] .delete-page-btn`);
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                lucide.createIcons();
            }
            
            try {
                // First check if user is still logged in
                const profileResponse = await fetch('/api/user/profile');
                if (!profileResponse.ok) {
                    alert('Your session has expired. Please log in again.');
                    window.location.href = '/sign';
                    return;
                }
                
                const response = await fetch(`/api/projects/${pageId}`, {
                    method: 'DELETE'
                });
                
                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', response.headers);
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response received:', text);
                    alert('Server error: Received non-JSON response. Please check if you are logged in.');
                    return;
                }
                
                const data = await response.json();
                console.log('Delete response data:', data);
                
                if (data.success) {
                    // Show success message and reload page
                    alert('Page deleted successfully!');
                    // Reload the page to ensure everything is updated
                    window.location.reload();
                } else {
                    alert('Failed to delete page: ' + data.message);
                    // Reset button state on error
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                        lucide.createIcons();
                    }
                }
            } catch (error) {
                console.error('Error deleting page:', error);
                alert('Failed to delete page. Please try again.');
                // Reset button state on error
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4"></i>';
                    lucide.createIcons();
                }
            }
        };
        
        const renderPagesTable = () => {
            const container = getElement('pages-list-container');
            if (state.pages.length === 0) {
                 container.innerHTML = `<div class="text-center py-16"><i data-lucide="globe-2" class="w-16 h-16 mx-auto text-gray-600"></i><h3 class="mt-4 text-lg font-semibold">No Hosted Pages Yet</h3><p class="mt-1 text-sm text-gray-400">Click "Host New Page" to deploy your first website.</p></div>`;
            } else {
                 const pageRows = state.pages.map(p => {
                    const expDate = new Date(p.expirationDate);
                    const diffDays = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
                    const expiresInText = diffDays > 0 ? `${diffDays} Day(s)` : diffDays === 0 ? 'Today' : 'Expired';
                    const formattedDate = expDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    return `<tr class="border-b border-gray-800 hover:bg-gray-700/20" data-page-id="${p.id}"><td class="px-6 py-4 font-medium">${p.title}</td><td class="px-6 py-4">${getStatusBadge(p.status)}</td><td class="px-6 py-4 text-gray-400"><div>${formattedDate}</div><div class="text-xs text-gray-500">(${expiresInText})</div></td><td class="px-6 py-4"><div class="flex items-center gap-2"><a href="https://outa.online/p/${p.id}" target="_blank" class="text-indigo-400 hover:underline">outa.online/p/${p.id}</a><button title="Copy Link" class="copy-link-btn p-1 hover:bg-gray-600 rounded-md"><i data-lucide="copy" class="w-3 h-3"></i></button></div></td><td class="px-6 py-4 text-right flex justify-end gap-2"><button title="View Analytics" class="view-analytics-btn p-2 hover:bg-gray-600 rounded-md"><i data-lucide="bar-chart-3" class="w-4 h-4"></i></button><button title="Delete Page" class="delete-page-btn p-2 hover:bg-gray-600 rounded-md" data-page-id="${p.id}"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button></td></tr>`;
                 }).join('');
                 container.innerHTML = createTable('<th class="px-6 py-3">Page Title</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Expires</th><th class="px-6 py-3">Link</th><th class="px-6 py-3 text-right">Actions</th>', pageRows);
            }
            lucide.createIcons();
        };

        // --- MODAL LOGIC ---
        const hostingModal = getElement('hosting-modal');
        const deleteModal = getElement('delete-modal');
        const openModal = (modal) => modal.classList.add('open');
        const closeModal = (modal) => {
            modal.classList.remove('open');
            if (modal === hostingModal) {
                 ['page-title-input', 'full-code', 'track-conversion-btn', 'track-product-name', 'track-product-price', 'track-customer-name', 'track-customer-phone', 'track-customer-city'].forEach(id => getElement(id).value = '');
                 getElement('modal-error').textContent = '';
            }
        };
        
        const optionsContainer = getElement('hosting-options-container');
        const DURATION_OPTIONS = [ 
            { days: 1, title: '24 Hours', subtitle: 'Quick Test' }, 
            { days: 7, title: '7 Days', subtitle: 'Preview Link', default: true }, 
            { days: 14, title: '14 Days', subtitle: 'Short Campaign' },
            { days: 30, title: '30 Days', subtitle: 'Beta Launch' },
            { days: 60, title: '60 Days', subtitle: 'Extended Campaign' },
            { days: 90, title: '90 Days', subtitle: 'Long Term Project' }
        ];
        let selectedDuration = DURATION_OPTIONS.find(opt => opt.default).days;

        optionsContainer.innerHTML = DURATION_OPTIONS.map(opt => `<div class="content-card rounded-lg p-3 text-center cursor-pointer border-2 transition-all duration-200 hover:border-indigo-400 hover:bg-indigo-500/10 ${opt.default ? 'border-indigo-500 bg-indigo-500/20' : 'border-transparent'}" data-duration="${opt.days}"><h3 class="font-bold text-md">${opt.title}</h3><p class="text-xs text-gray-400">${opt.subtitle}</p></div>`).join('');
        optionsContainer.addEventListener('click', (e) => {
            console.log('Duration option clicked:', e.target);
            const selectedOption = e.target.closest('[data-duration]');
            console.log('Selected option:', selectedOption);
            if (!selectedOption) return;
            
            // Remove border and background from all options
            optionsContainer.querySelectorAll('[data-duration]').forEach(opt => {
                opt.classList.remove('border-indigo-500', 'bg-indigo-500/20');
                opt.classList.add('border-transparent');
            });
            
            // Add border and background to selected option
            selectedOption.classList.add('border-indigo-500', 'bg-indigo-500/20');
            selectedOption.classList.remove('border-transparent');
            
            selectedDuration = parseInt(selectedOption.dataset.duration, 10);
            console.log('Selected duration:', selectedDuration);
        });

        getElement('host-new-page-btn').addEventListener('click', () => openModal(hostingModal));
        getElement('close-modal-btn').addEventListener('click', () => closeModal(hostingModal));
        getElement('cancel-deploy-btn').addEventListener('click', () => closeModal(hostingModal));
        getElement('cancel-delete-btn').addEventListener('click', () => closeModal(deleteModal));
        
        getElement('confirm-delete-btn').addEventListener('click', () => {
            state.pages = state.pages.filter(p => p.id !== pageIdToDelete);
            renderPagesTable(); 
            renderProducts(); 
            renderPageUsage();
            closeModal(deleteModal); 
            pageIdToDelete = null;
        });

        // --- DEPLOY & ACTIONS ---
        getElement('deploy-btn').addEventListener('click', async () => {
            if (state.pages.length >= state.pageLimit) {
                getElement('modal-error').textContent = 'Page limit reached. Please delete a page to host a new one.';
                setTimeout(() => getElement('modal-error').textContent = '', 3000);
                return;
            }

            const title = getElement('page-title-input').value || 'Untitled Page';
            const htmlCode = getElement('full-code').value || '<h1>Hello World!</h1><p>This is a new hosted page.</p>';
            const conversionButtonName = getElement('track-conversion-btn').value.trim();
            const conversionTrackingEnabled = conversionButtonName.length > 0;
            const productName = getElement('track-product-name').value.trim();
            const productPrice = getElement('track-product-price').value.trim();
            const customerNamePlaceholder = getElement('track-customer-name').value.trim();
            const customerPhonePlaceholder = getElement('track-customer-phone').value.trim();
            const customerCityPlaceholder = getElement('track-customer-city').value.trim();
            
            try {
                // Create the project in the database
                const response = await fetch('/api/projects/host', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        html_code: htmlCode,
                        css_code: '',
                        js_code: '',
                        conversion_button_name: conversionButtonName,
                        conversion_tracking_enabled: conversionTrackingEnabled,
                        product_name: productName,
                        product_price: productPrice,
                        customer_name_placeholder: customerNamePlaceholder,
                        customer_phone_placeholder: customerPhonePlaceholder,
                        customer_city_placeholder: customerCityPlaceholder,
                        duration_days: selectedDuration
                    })
                });
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    // Refresh the pages list to show the new hosted page
                    await fetchPages();
             closeModal(hostingModal);
                    
                    // Clear the form
                    getElement('page-title-input').value = '';
                    getElement('full-code').value = '';
                    getElement('track-conversion-btn').value = '';
                    getElement('track-product-name').value = '';
                    getElement('track-product-price').value = '';
                    getElement('track-customer-name').value = '';
                    getElement('track-customer-phone').value = '';
                    getElement('track-customer-city').value = '';
                } else {
                    console.error('API Error:', data);
                    getElement('modal-error').textContent = 'Failed to create hosted page: ' + (data.message || 'Unknown error');
                    setTimeout(() => getElement('modal-error').textContent = '', 3000);
                }
            } catch (error) {
                console.error('Error creating hosted page:', error);
                getElement('modal-error').textContent = 'Failed to create hosted page. Please try again.';
                setTimeout(() => getElement('modal-error').textContent = '', 3000);
            }
        });

        getElement('pages-list-container').addEventListener('click', e => {
            const row = e.target.closest('tr');
            if (!row) return;
            const pageId = row.dataset.pageId;
            const copyBtn = e.target.closest('.copy-link-btn');
            const deleteBtn = e.target.closest('.delete-page-btn');
            const analyticsBtn = e.target.closest('.view-analytics-btn');

            if (copyBtn) {
                navigator.clipboard.writeText(copyBtn.previousElementSibling.href).then(() => {
                    const originalIcon = copyBtn.innerHTML;
                    copyBtn.innerHTML = `<i data-lucide="check" class="w-3 h-3 text-emerald-400"></i>`;
                    lucide.createIcons();
                    setTimeout(() => { copyBtn.innerHTML = originalIcon; lucide.createIcons(); }, 2000);
                });
            } else if (deleteBtn) {
                const deletePageId = deleteBtn.dataset.pageId || pageId;
                deleteHostedPage(deletePageId);
            } else if (analyticsBtn) {
                navigateToPage('page-analytics', pageId);
            }
        });
        
        getElement('products-list-container').addEventListener('click', e => {
             const link = e.target.closest('.view-hosted-page-link');
             if(link) { e.preventDefault(); navigateToPage('page-hosted-pages'); }
        });
        
        getElement('analytics-page-selector').addEventListener('change', (e) => {
            const projectId = e.target.value === 'all' ? null : e.target.value;
            fetchAnalytics(projectId);
            updateAnalyticsCharts(projectId);
        });

        // --- DATE & TIME ---
        const updateTime = () => {
            const now = new Date();
            getElement('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            getElement('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        };

        const populateAnalyticsSelector = () => {
            const selector = getElement('analytics-page-selector');
            selector.innerHTML = '<option value="all">All Pages</option>';
            state.pages.forEach(p => selector.innerHTML += `<option value="${p.id}">${p.title}</option>`);
        };

        // Update user avatar display
        const updateUserAvatar = (user) => {
            const avatarElement = getElement('user-avatar');
            console.log('Updating user avatar:', user);
            
            if (user.profile_image) {
                // Show profile image with error handling
                console.log('Setting profile image:', user.profile_image);
                avatarElement.innerHTML = `<img src="${user.profile_image}" alt="User Avatar" class="w-9 h-9 rounded-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <span class="w-9 h-9 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-semibold text-sm" style="display:none;">${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</span>`;
            } else {
                // Show first letter of name
                const firstLetter = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                console.log('Setting initial letter:', firstLetter);
                avatarElement.innerHTML = `<span class="text-white font-semibold text-sm">${firstLetter}</span>`;
            }
        };

        // Check admin status and show/hide admin dashboard link
        const checkAdminStatus = async () => {
            try {
                const response = await fetch('/api/user/profile');
                const data = await response.json();
                
                if (data.success && data.user) {
                    // Update avatar
                    updateUserAvatar(data.user);
                    
                    // Show/hide admin dashboard link
                    if (data.user.is_admin) {
                        getElement('admin-dashboard-link').classList.remove('hidden');
                    } else {
                        getElement('admin-dashboard-link').classList.add('hidden');
                    }
                } else {
                    getElement('admin-dashboard-link').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
                getElement('admin-dashboard-link').classList.add('hidden');
            }
        };

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateTime();
            setInterval(updateTime, 1000 * 60);
            
            // Check if user is admin and show admin dashboard link
            checkAdminStatus();
            
            // Load initial data
            fetchNotifications();
            checkExpiringPages();
            
            navigateToPage('page-dashboard');
        });
    </script>
</body>
</html>


